# 捉红3在线纸牌游戏开发需求文档

## 一、项目概述

- **项目名称**：捉红3在线纸牌游戏
- **目标平台**：H5移动端/Web端
- **游戏类型**：多人在线对战纸牌游戏
- **目标用户群体**：扑克牌爱好者、社交游戏玩家

---

## 二、核心玩法与规则

### 1. 牌组与人数

- 使用一副扑克牌（含大小王），去除所有4个6（共54-4=50张）
- 5名玩家，每人发10张牌，全部发完，不留底牌

### 2. 阵营划分

- 持有红桃3（♥3）和方片3（♦3）的玩家为红三方
- 其余玩家为黑三方（非红三方）
- **特殊情况**：如果两张红3在同一玩家手中，则红三方只有1人，黑三方有4人

### 3. 发牌与出牌

- 随机发牌，每人10张
- 持有红桃5（♥5）的玩家首家，第一轮必须出含红桃5的牌
- 出牌顺序为逆时针
- 出牌类型：
  - 单张
  - 对子
  - 炸弹（三张或四张同点数，双王，双红3）

### 4. 牌型大小

#### 单张大小顺序（从大到小）：
大王 > 小王 > 红桃3 = 方片3 > 4 > 黑3 > 2 > A > K > Q > J > 10 > 9 > 8 > 7 > 5

#### 炸弹大小顺序（从大到小）：
双王 > 双红3 > 四张同点数 > 三张同点数

#### 炸弹内部比较：
- 四张炸弹按点数比较（如4个4 > 4个3）
- 三张炸弹按点数比较

#### 特殊规则：
- 红3和黑3组成的对子/炸弹，按黑3的大小计算（小于4）
- 必须"管"上家（出更大的同类型牌或用炸弹），否则"不要"

### 5. 亮牌机制

- 发牌后，进入亮牌阶段（10秒内可亮牌）
- **方片3（♦3）**：必须强制亮出
- **红桃3（♥3）**：可自主选择是否亮出
- **黑桃3（♠3）、梅花3（♣3）**：可自主选择是否亮出

### 6. 积分规则

#### 基础积分计算：
- 方片3必须亮出，基础积分为 **1**
- 红桃3亮出：积分基数 **+2**
- 每亮出一张黑3（♠3或♣3）：积分基数 **+1**

#### 附加积分计算：
- 附加分 = 输方还有牌未出完的玩家数量
- 最终积分基数 = 基础积分 + 附加积分

#### 玩家积分变化：
- 红桃3持有者：积分变化 = 最终积分基数 × 2
- 其他玩家：积分变化 = 最终积分基数
- 获胜方加分，失败方扣分

#### 积分计算示例：
| 场景 | 基础分 | 附加分 | 红桃3玩家变化 | 其他玩家变化 |
|-----|-------|-------|-------------|------------|
| 只亮方片3，输方3人有牌 | 1 | 3 | ±8 | ±4 |
| 亮红桃3+1黑3，输方2人有牌 | 4 | 2 | ±12 | ±6 |

### 7. 胜负判定

- 任意一方有玩家最先出完手牌，则该方全体获胜
- 同队玩家共同获胜/失败

---

## 三、功能需求

### 1. 游戏模式

#### 单人模式（已实现）
- 1名玩家 + 4名AI
- AI自动出牌逻辑

#### 多人模式（已实现）
- 5名真人玩家
- 房间制：创建房间/加入房间
- Socket.io实时同步

### 2. 游戏流程

1. **等待阶段**：等待5名玩家就位
2. **发牌阶段**：随机发牌，每人10张
3. **亮牌阶段**：10秒倒计时，玩家选择亮牌
4. **出牌阶段**：
   - 红桃5持有者先出
   - 第一轮必须出含红桃5的牌
   - 逆时针轮流出牌
5. **结算阶段**：
   - 计算积分变化
   - 显示胜负结果
   - 可选择"再来一局"

### 3. 交互与UI

- 手牌展示与选择
- 出牌/不要按钮
- 亮牌操作
- 玩家位置与头像
- 出牌动画
- 积分变动显示

---

## 四、项目架构

### 目录结构
```
抓红三/
├── public/              # 静态资源
├── src/                 # 前端源码
│   ├── components/      # React组件
│   │   ├── Card.js     # 单张牌组件
│   │   ├── CardStack.js # 手牌组件
│   │   ├── GameBoard.js # 游戏主界面
│   │   └── ...
│   ├── game/           # 前端游戏逻辑（重新导出shared模块）
│   │   ├── deck.js     # 牌组相关
│   │   └── rules.js    # 规则相关
│   ├── hooks/          # React Hooks
│   │   └── useGame.js  # 游戏状态管理
│   └── App.js          # 应用入口
├── server/             # 服务器端
│   ├── index.js        # Socket.io服务器
│   └── package.json    # 服务器依赖
├── shared/             # 共享模块（前端和服务器共用）
│   └── game-core.js    # 核心游戏逻辑
└── package.json        # 前端依赖
```

### 核心模块说明

#### shared/game-core.js
前端和服务器共用的游戏核心逻辑，包含：
- 常量定义（花色、牌型等）
- 牌判断函数（isRedThree, isJoker等）
- 牌组函数（createDeck, shuffleDeck, dealCards）
- 牌型判断（getCardType, canBeat）
- 积分计算（calculateBaseScore, calculateBonusScore, calculateScoreChanges）
- 出牌提示（findAllValidPlays）

#### server/index.js
多人游戏服务器：
- Socket.io实时通信
- 房间管理
- 游戏状态同步
- 积分计算

#### src/hooks/useGame.js
单人游戏状态管理：
- 游戏状态（发牌、亮牌、出牌、结算）
- AI逻辑
- 积分计算

---

## 五、部署指南

### 本地开发

```bash
# 安装前端依赖
npm install

# 安装服务器依赖
cd server && npm install

# 启动前端（端口3000）
npm start

# 启动服务器（端口3002）
cd server && npm start
```

### Windows部署

1. **安装Node.js**
   - 下载：https://nodejs.org
   - 选择LTS版本（18.x或20.x）
   - 安装时勾选"Add to PATH"

2. **复制项目**
   - 将整个`抓红三`文件夹复制到Windows电脑

3. **安装依赖**
   ```bash
   cd 抓红三
   npm install
   cd server
   npm install
   ```

4. **启动服务**
   ```bash
   # 终端1 - 启动服务器
   cd server
   node index.js

   # 终端2 - 启动前端
   cd 抓红三
   npm start
   ```

### 内网穿透（让外网访问）

使用ngrok：
```bash
# 下载：https://ngrok.com/download

# 穿透前端
ngrok http 3000

# 另开终端，穿透服务器
ngrok http 3002
```

ngrok会生成公网地址，分享给朋友即可访问。

---

## 六、技术栈

- **前端**：React + CSS
- **后端**：Node.js + Express + Socket.io
- **通信**：WebSocket（Socket.io）

---

## 七、版本记录

### v1.0 - 初始版本
- 基础游戏规则实现
- 单人模式（AI对战）
- 多人模式（房间制）

### v1.1 - 规则修正
- 修复红3+黑3混合牌型大小判断
- 统一积分规则（对称计分）
- 共享游戏核心模块（单人/多人统一逻辑）

---

## 八、后续优化方向

- [ ] 用户系统（登录/注册/积分排行）
- [ ] 好友系统
- [ ] 观战模式
- [ ] 音效与动画优化
- [ ] 断线重连机制
- [ ] 移动端适配优化
